--每个公司 commit 加减行数占比
select company,
       max(end_time)          end_time,
       min(start_time) as     start_time,
       sum(total__insertions) total__insertions,
       sum(total__deletions)  total__deletions,
       sum(total__lines)      total__lines,
       sum(commit_count)      commit_count,
       round(total__insertions/(select sum(total__insertions) from gits where search_key__repo = 'linux' and if_merged = 0)*100,3) as insertions_percentage,
       round(total__deletions/(select sum(total__deletions) from gits where search_key__repo = 'linux' and if_merged = 0)*100,3) as deletions_percentage,
       round(total__lines/(select sum(total__lines) from gits where search_key__repo = 'linux' and if_merged = 0)*100,3) as all_lines_percentage,
       round(commit_count/(select count() from gits where search_key__repo = 'linux' and if_merged = 0)*100,3) as commit_percentage
from (select multiIf(email_domain like '%huawei%' or email_domain = 'hisilicon.com', 'huawei',
                     email_domain like '%google%' or email_domain = 'android.com' or email_domain = 'chrome.com' or
                     email_domain = 'chromium.org' or email_domain = 'tensorflow.org', 'google',
                     email_domain like '%intel%', 'intel', 'redhat') as company,
             end_time,
             start_time,
             total__insertions,
             total__deletions,
             total__lines,
             commit_count
      from (select splitByChar('@', author_email)[2] as email_domain,
                   max(authored_date)                as end_time,
                   min(authored_date)                as start_time,
                   sum(total__insertions)            as total__insertions,
                   sum(total__deletions)             as total__deletions,
                   sum(total__lines)                 as total__lines,
                   count()                           as commit_count
            from gits
            where if_merged = 0
              and search_key__repo = 'linux'
              and (email_domain like '%intel%' or email_domain like '%google%' or email_domain like '%redhat%' or
                   email_domain like '%huawei%' or email_domain = 'android.com' or email_domain = 'chrome.com' or
                   email_domain = 'chromium.org' or email_domain = 'tensorflow.org' or email_domain = 'hisilicon.com' or
                   email_domain = 'china.huawei.com')
            group by email_domain
            order by total__lines desc))
group by company
order by total__lines desc

















-- rust 华为专家 metrics
select if(a.login != '', a.login, b.login) as login,
       create_issues_count,
       issues_comments_count,
       create_pr_count,
       reviewed_count,
       commit_committer_count from (select if(a.login != '', a.login, b.login) as login,
       create_issues_count,
       create_pr_count,
       reviewed_count,
       commit_committer_count
from (select if(a.login != '', a.login, b.login) as login, create_issues_count, create_pr_count, reviewed_count
      from (select if(a.login != '', a.login, b.login) as login, create_issues_count, create_pr_count
            from (-- 统计issues提出次数 近三年
                     select login, count() as create_issues_count
                     from (select argMax(user__login, created_at) as login
                           from github_issues
                           where search_key__repo = 'rust'
                             and pull_request__url = ''
                             and toYear(created_at) >= 2018
                           group by node_id)
                     where login global in ('Amanieu',
                                            'bdqnghi',
                                            'davidtwco',
                                            'GuillaumeGomez',
                                            'J-ZhengLi',
                                            'KarliosQu',
                                            'lcnr',
                                            'LuuuXXX',
                                            'm-ou-se',
                                            'MabinGo',
                                            'MichaelLing83',
                                            'mojave2',
                                            'petrochenkov',
                                            'QiangHeisenberg',
                                            'Sea-Chunmiao',
                                            'SparrowLii',
                                            'stevetan81',
                                            'surechen',
                                            'wain303009',
                                            'wangkirin',
                                            'yijunyu')
                     group by login
                     order by create_issues_count desc) as a global
                     full join (-- 统计pr提出次数 近三年
                select login, count() as create_pr_count
                from (select argMax(user__login, created_at) as login
                      from github_pull_requests
                      where search_key__repo = 'rust'
                        and toYear(created_at) >= 2018
                      group by node_id)
                where login global in ('Amanieu',
                                       'bdqnghi',
                                       'davidtwco',
                                       'GuillaumeGomez',
                                       'J-ZhengLi',
                                       'KarliosQu',
                                       'lcnr',
                                       'LuuuXXX',
                                       'm-ou-se',
                                       'MabinGo',
                                       'MichaelLing83',
                                       'mojave2',
                                       'petrochenkov',
                                       'QiangHeisenberg',
                                       'Sea-Chunmiao',
                                       'SparrowLii',
                                       'stevetan81',
                                       'surechen',
                                       'wain303009',
                                       'wangkirin',
                                       'yijunyu')
                group by login
                order by create_pr_count desc) as b on a.login = b.login) as a global
               full join (select login, count() reviewed_count
                          from (select JSONExtractString(timeline_raw, 'node_id')            as node_id,
                                       JSONExtractString(JSONExtractString(argMax(timeline_raw,
                                                                                  parseDateTimeBestEffort(JSONExtractString(timeline_raw, 'submitted_at'))),
                                                                           'user'), 'login') as login
                                from github_issues_timeline
                                where search_key__repo = 'rust'
                                  and toYear(parseDateTimeBestEffort(JSONExtractString(timeline_raw, 'submitted_at'))) >=
                                      2018
                                  and search_key__event = 'reviewed'

                                group by node_id)
                          where login global in ('Amanieu',
                                                 'bdqnghi',
                                                 'davidtwco',
                                                 'GuillaumeGomez',
                                                 'J-ZhengLi',
                                                 'KarliosQu',
                                                 'lcnr',
                                                 'LuuuXXX',
                                                 'm-ou-se',
                                                 'MabinGo',
                                                 'MichaelLing83',
                                                 'mojave2',
                                                 'petrochenkov',
                                                 'QiangHeisenberg',
                                                 'Sea-Chunmiao',
                                                 'SparrowLii',
                                                 'stevetan81',
                                                 'surechen',
                                                 'wain303009',
                                                 'wangkirin',
                                                 'yijunyu')
                          group by login
                          order by reviewed_count desc) as b on a.login = b.login) as a global
         full join (-- 作为一个committer
    select login, count() as commit_committer_count
    from (select sha, argMax(committer__login, commit__committer__date) as login
          from github_commits
          where search_key__repo = 'rust'
            and toYear(commit__committer__date) >= 2018
            and committer__login global in ('Amanieu',
                                            'bdqnghi',
                                            'davidtwco',
                                            'GuillaumeGomez',
                                            'J-ZhengLi',
                                            'KarliosQu',
                                            'lcnr',
                                            'LuuuXXX',
                                            'm-ou-se',
                                            'MabinGo',
                                            'MichaelLing83',
                                            'mojave2',
                                            'petrochenkov',
                                            'QiangHeisenberg',
                                            'Sea-Chunmiao',
                                            'SparrowLii',
                                            'stevetan81',
                                            'surechen',
                                            'wain303009',
                                            'wangkirin',
                                            'yijunyu')
          group by sha)
    group by login
    order by commit_committer_count desc) as b on a.login = b.login) as a global full join (select login,count() as issues_comments_count from (select node_id,argMax(user__login,created_at) as login from github_issues_comments where search_key__repo = 'rust' and user__login global in ('Amanieu',
                                            'bdqnghi',
                                            'davidtwco',
                                            'GuillaumeGomez',
                                            'J-ZhengLi',
                                            'KarliosQu',
                                            'lcnr',
                                            'LuuuXXX',
                                            'm-ou-se',
                                            'MabinGo',
                                            'MichaelLing83',
                                            'mojave2',
                                            'petrochenkov',
                                            'QiangHeisenberg',
                                            'Sea-Chunmiao',
                                            'SparrowLii',
                                            'stevetan81',
                                            'surechen',
                                            'wain303009',
                                            'wangkirin',
                                            'yijunyu') and toYear(created_at) >= 2018
            and search_key__number global in  (select number from github_issues where github_issues.search_key__repo='rust' and  pull_request__url = '' group by number)
 group by node_id) group by login order by issues_comments_count desc) as b on a.login = b.login
